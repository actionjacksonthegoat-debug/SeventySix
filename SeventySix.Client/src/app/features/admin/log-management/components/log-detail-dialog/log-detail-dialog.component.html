<div
	class="log-detail-dialog"
	role="dialog"
	aria-labelledby="log-dialog-title"
	aria-describedby="log-dialog-description"
>
	<!-- Header -->
	<div mat-dialog-title class="dialog-header">
		<div class="header-content" id="log-dialog-title">
			<mat-icon
				[class.level-debug]="
					getLevelClass(log().logLevel) === 'level-debug'
				"
				[class.level-info]="
					getLevelClass(log().logLevel) === 'level-info'
				"
				[class.level-warning]="
					getLevelClass(log().logLevel) === 'level-warning'
				"
				[class.level-error]="
					getLevelClass(log().logLevel) === 'level-error'
				"
				[class.level-critical]="
					getLevelClass(log().logLevel) === 'level-critical'
				"
				attr.aria-label="Log level: {{ getLevelName(log().logLevel) }}"
				>{{ getLevelIcon(log().logLevel) }}</mat-icon
			>
			<span
				class="level-name"
				[class.level-debug]="
					getLevelClass(log().logLevel) === 'level-debug'
				"
				[class.level-info]="
					getLevelClass(log().logLevel) === 'level-info'
				"
				[class.level-warning]="
					getLevelClass(log().logLevel) === 'level-warning'
				"
				[class.level-error]="
					getLevelClass(log().logLevel) === 'level-error'
				"
				[class.level-critical]="
					getLevelClass(log().logLevel) === 'level-critical'
				"
				>{{ getLevelName(log().logLevel) }}</span
			>
			@if (log().sourceContext)
			{
				<span class="source-context">• {{ log().sourceContext }}</span>
			}
			<span class="timestamp"
				>• {{ getRelativeTime(log().createDate) }}</span
			>
		</div>
		<div class="header-actions">
			@if (isObservabilityEnabled)
			{
				<button
					mat-icon-button
					(click)="openInJaeger()"
					[matTooltip]="
						hasCorrelationId()
							? 'View this trace in Jaeger'
							: 'No trace ID available. Enable OpenTelemetry in your backend to track distributed traces.'
					"
					[disabled]="!hasCorrelationId()"
					aria-label="Open this specific trace in Jaeger"
					color="warn"
				>
					<mat-icon>bug_report</mat-icon>
				</button>
			}
			<button
				mat-icon-button
				(click)="copyToClipboard()"
				matTooltip="Copy to clipboard"
				aria-label="Copy log details to clipboard"
			>
				<mat-icon>content_copy</mat-icon>
			</button>
			<button
				mat-icon-button
				(click)="onDelete()"
				matTooltip="Delete log"
				color="warn"
				aria-label="Delete this log entry"
			>
				<mat-icon>delete</mat-icon>
			</button>
			<button
				mat-icon-button
				(click)="onClose()"
				matTooltip="Close (Esc)"
				aria-label="Close dialog (Press Escape)"
			>
				<mat-icon>close</mat-icon>
			</button>
		</div>
	</div>

	<mat-divider></mat-divider>

	<!-- Content -->
	<div mat-dialog-content class="dialog-content" id="log-dialog-description">
		<!-- Message Section -->
		<section class="detail-section">
			<h3 class="section-title">Message</h3>
			<div class="section-content message-content">
				{{ log().message }}
			</div>
		</section>

		<mat-divider></mat-divider>

		<!-- Exception Section (Enhanced) -->
		@if (log().exception)
		{
			<section class="detail-section error-section">
				<div class="section-header">
					<h3 class="section-title">
						<mat-icon class="section-icon error-icon"
							>error</mat-icon
						>
						Exception Details
					</h3>
					<button
						mat-icon-button
						(click)="toggleException()"
						[matTooltip]="
							exceptionCollapsed() ? 'Expand' : 'Collapse'
						"
					>
						<mat-icon>{{
							exceptionCollapsed() ? "expand_more" : "expand_less"
						}}</mat-icon>
					</button>
				</div>
				@if (!exceptionCollapsed())
				{
					<div class="section-content">
						<!-- Exception Type & Message -->
						<div class="error-breakdown">
							<div class="error-item exception-message">
								<div class="error-label">
									<mat-icon>message</mat-icon>
									<span>Exception Message</span>
								</div>
								<div class="error-value">
									{{ getExceptionMessage(log().exception) }}
								</div>
							</div>

							<!-- Exception Type -->
							@if (getExceptionType(log().exception))
							{
								<div class="error-item exception-type">
									<div class="error-label">
										<mat-icon>label</mat-icon>
										<span>Exception Type</span>
									</div>
									<div class="error-value">
										{{ getExceptionType(log().exception) }}
									</div>
								</div>
							}

							<!-- Base Exception -->
							@if (getBaseException(log().exception))
							{
								<div class="error-item base-exception">
									<div class="error-label">
										<mat-icon>report</mat-icon>
										<span>Base Exception</span>
									</div>
									<div class="error-value">
										{{ getBaseException(log().exception) }}
									</div>
								</div>
							}

							<!-- Inner Exceptions -->
							@if (
								getInnerExceptions(log().exception);
								as innerExceptions
							)
							{
								@if (innerExceptions.length > 0)
								{
									<div class="error-item inner-exceptions">
										<div class="error-label">
											<mat-icon>layers</mat-icon>
											<span
												>Inner Exceptions ({{
													innerExceptions.length
												}})</span
											>
										</div>
										<div class="error-value">
											@for (
												inner of innerExceptions;
												track $index
											)
											{
												<div
													class="inner-exception-item"
												>
													<span class="inner-number"
														>{{ $index + 1 }}.</span
													>
													<span>{{ inner }}</span>
												</div>
											}
										</div>
									</div>
								}
							}

							<!-- Full Exception Text -->
							<div class="error-item full-exception">
								<div class="error-label">
									<mat-icon>description</mat-icon>
									<span>Full Exception</span>
								</div>
								<div class="error-value exception-content">
									<pre>{{ log().exception }}</pre>
								</div>
							</div>
						</div>
					</div>
				}
			</section>

			<mat-divider></mat-divider>
		}

		<!-- Stack Trace Section (Enhanced) -->
		@if (log().stackTrace)
		{
			<section class="detail-section stack-section">
				<div class="section-header">
					<h3 class="section-title">
						<mat-icon class="section-icon stack-icon"
							>code</mat-icon
						>
						Stack Trace
					</h3>
					<button
						mat-icon-button
						(click)="toggleStackTrace()"
						[matTooltip]="
							stackTraceCollapsed() ? 'Expand' : 'Collapse'
						"
					>
						<mat-icon>{{
							stackTraceCollapsed()
								? "expand_more"
								: "expand_less"
						}}</mat-icon>
					</button>
				</div>
				@if (!stackTraceCollapsed())
				{
					<div class="section-content">
						<div class="stack-breakdown">
							<!-- Stack Frame Count -->
							<div class="stack-info">
								<mat-icon>info</mat-icon>
								<span
									>{{
										getStackFrameCount(log().stackTrace)
									}}
									stack frames</span
								>
							</div>

							<!-- Stack Trace Content -->
							<div class="stack-trace-content">
								<pre>{{
									formatStackTrace(log().stackTrace)
								}}</pre>
							</div>
						</div>
					</div>
				}
			</section>

			<mat-divider></mat-divider>
		}

		<!-- Request Information Section -->
		@if (log().requestPath || log().statusCode || log().duration)
		{
			<section class="detail-section">
				<h3 class="section-title">Request Information</h3>
				<div class="section-content info-grid">
					@if (log().requestPath)
					{
						<div class="info-item">
							<span class="info-label">Path:</span>
							<span class="info-value">{{
								log().requestPath
							}}</span>
						</div>
					}
					@if (log().statusCode)
					{
						<div class="info-item">
							<span class="info-label">Status Code:</span>
							<span class="info-value">{{
								log().statusCode
							}}</span>
						</div>
					}
					@if (log().duration)
					{
						<div class="info-item">
							<span class="info-label">Duration:</span>
							<span class="info-value"
								>{{ log().duration }} ms</span
							>
						</div>
					}
					@if (log().requestId)
					{
						<div class="info-item">
							<span class="info-label">Request ID:</span>
							<span class="info-value">{{
								log().requestId
							}}</span>
						</div>
					}
					@if (log().correlationId)
					{
						<div class="info-item">
							<span class="info-label">Correlation ID:</span>
							<span class="info-value">{{
								log().correlationId
							}}</span>
						</div>
					}
					@if (log().spanId)
					{
						<div class="info-item">
							<span class="info-label">Span ID:</span>
							<span class="info-value">{{ log().spanId }}</span>
						</div>
					}
					@if (log().parentSpanId)
					{
						<div class="info-item">
							<span class="info-label">Parent Span ID:</span>
							<span
								class="info-value"
								[matTooltip]="
									isRootSpan(log().parentSpanId)
										? 'All zeros indicates this is a root span (top-level request with no parent)'
										: ''
								"
							>
								{{
									isRootSpan(log().parentSpanId)
										? log().parentSpanId + " (Root Span)"
										: log().parentSpanId
								}}
							</span>
						</div>
					}
				</div>
			</section>

			<mat-divider></mat-divider>
		}

		<!-- User Information Section -->
		@if (
			log().userId || log().userName || log().clientIp || log().userAgent
		)
		{
			<section class="detail-section">
				<h3 class="section-title">User Information</h3>
				<div class="section-content info-grid">
					@if (log().userId)
					{
						<div class="info-item">
							<span class="info-label">User ID:</span>
							<span class="info-value">{{ log().userId }}</span>
						</div>
					}
					@if (log().userName)
					{
						<div class="info-item">
							<span class="info-label">Username:</span>
							<span class="info-value">{{ log().userName }}</span>
						</div>
					}
					@if (log().clientIp)
					{
						<div class="info-item">
							<span class="info-label">IP Address:</span>
							<span class="info-value">{{ log().clientIp }}</span>
						</div>
					}
					@if (log().userAgent)
					{
						<div class="info-item">
							<span class="info-label">User Agent:</span>
							<span class="info-value">{{
								log().userAgent
							}}</span>
						</div>
					}
					@if (log().sessionId)
					{
						<div class="info-item">
							<span class="info-label">Session ID:</span>
							<span class="info-value">{{
								log().sessionId
							}}</span>
						</div>
					}
				</div>
			</section>

			<mat-divider></mat-divider>
		}

		<!-- Properties Section -->
		@if (log().properties)
		{
			<section class="detail-section">
				<div class="section-header">
					<h3 class="section-title">Properties</h3>
					<button
						mat-icon-button
						(click)="toggleProperties()"
						[matTooltip]="
							propertiesCollapsed() ? 'Expand' : 'Collapse'
						"
					>
						<mat-icon>{{
							propertiesCollapsed()
								? "expand_more"
								: "expand_less"
						}}</mat-icon>
					</button>
				</div>
				@if (!propertiesCollapsed())
				{
					<div class="section-content properties-content">
						<pre>{{ formatProperties(log().properties) }}</pre>
					</div>
				}
			</section>

			<mat-divider></mat-divider>
		}

		<!-- Metadata Section -->
		<section class="detail-section">
			<h3 class="section-title">Metadata</h3>
			<div class="section-content info-grid">
				<div class="info-item">
					<span class="info-label">Log ID:</span>
					<span class="info-value">{{ log().id }}</span>
				</div>
				<div class="info-item">
					<span class="info-label">Timestamp:</span>
					<span class="info-value">{{
						log().createDate.toLocaleString()
					}}</span>
				</div>
				@if (log().machineName)
				{
					<div class="info-item">
						<span class="info-label">Machine:</span>
						<span class="info-value">{{ log().machineName }}</span>
					</div>
				}
				@if (log().environment)
				{
					<div class="info-item">
						<span class="info-label">Environment:</span>
						<span class="info-value">{{ log().environment }}</span>
					</div>
				}
				@if (log().application)
				{
					<div class="info-item">
						<span class="info-label">Application:</span>
						<span class="info-value">{{ log().application }}</span>
					</div>
				}
				@if (log().threadId)
				{
					<div class="info-item">
						<span class="info-label">Thread ID:</span>
						<span class="info-value">{{ log().threadId }}</span>
					</div>
				}
			</div>
		</section>
	</div>
</div>
