<div
	class="health-status-panel"
	role="region"
	aria-label="System health status"
>
	@if (isLoading())
	{
		<div class="loading-container" role="status" aria-live="polite">
			<mat-spinner
				diameter="40"
				aria-label="Loading health status"
			></mat-spinner>
			<p>Loading health status...</p>
		</div>
	}
	@else if (error())
	{
		<div class="error-container" role="alert" aria-live="assertive">
			<mat-icon color="warn" aria-hidden="true">error</mat-icon>
			<p>{{ error() }}</p>
			<button
				mat-raised-button
				color="primary"
				(click)="onRefresh()"
				aria-label="Retry loading health status"
			>
				<mat-icon aria-hidden="true">refresh</mat-icon>
				Retry
			</button>
		</div>
	}
	@else if (healthData())
	{
		<mat-card class="health-card">
			<!-- Header Section -->
			<mat-card-header class="health-header">
				<div class="header-content">
					<div class="title-section">
						<mat-icon class="header-icon">monitor_heart</mat-icon>
						<div>
							<mat-card-title
								>System Health Status</mat-card-title
							>
							<mat-card-subtitle>
								Last checked: {{ lastCheckedFormatted() }}
							</mat-card-subtitle>
						</div>
					</div>

					<div class="status-section">
						<!-- Overall Status Badge -->
						<mat-chip
							[highlighted]="true"
							[class.status-healthy]="
								healthData()!.status === 'Healthy'
							"
							[class.status-degraded]="
								healthData()!.status === 'Degraded'
							"
							[class.status-unhealthy]="
								healthData()!.status === 'Unhealthy'
							"
						>
							<mat-icon>{{
								getStatusIcon(healthData()!.status)
							}}</mat-icon>
							{{ healthData()!.status }}
						</mat-chip>

						@if (criticalIssuesCount() > 0)
						{
							<mat-chip class="issues-badge" [highlighted]="true">
								<mat-icon>warning</mat-icon>
								{{ criticalIssuesCount() }} Issue{{
									criticalIssuesCount() > 1 ? "s" : ""
								}}
							</mat-chip>
						}
					</div>
				</div>

				<!-- Action Buttons -->
				<div class="action-buttons">
					<mat-slide-toggle
						[checked]="autoRefreshEnabled()"
						(change)="toggleAutoRefresh()"
						color="primary"
						aria-label="Toggle auto-refresh"
					>
						Auto-refresh ({{ refreshIntervalSeconds() }}s)
					</mat-slide-toggle>
					<button
						mat-icon-button
						(click)="onRefresh()"
						[disabled]="isLoading()"
						matTooltip="Refresh now"
						aria-label="Refresh health status"
					>
						<mat-icon>refresh</mat-icon>
					</button>
				</div>
			</mat-card-header>

			<mat-divider></mat-divider>

			<!-- Content Grid -->
			<mat-card-content class="health-content">
				<div class="health-grid">
					<!-- Database Health Card -->
					<div class="metric-card database-card">
						<div class="card-header">
							<mat-icon
								[class.icon-healthy]="
									healthData()!.database.isConnected
								"
								[class.icon-error]="
									!healthData()!.database.isConnected
								"
							>
								storage
							</mat-icon>
							<h3>Database</h3>
							<mat-chip
								class="status-chip"
								[class.status-healthy]="
									healthData()!.database.status === 'Healthy'
								"
								[class.status-degraded]="
									healthData()!.database.status === 'Degraded'
								"
								[class.status-unhealthy]="
									healthData()!.database.status ===
									'Unhealthy'
								"
							>
								{{ healthData()!.database.status }}
							</mat-chip>
						</div>

						<div class="card-content">
							<div class="metric-row">
								<span class="metric-label">Connection</span>
								<span
									class="metric-value"
									[class.value-success]="
										healthData()!.database.isConnected
									"
									[class.value-error]="
										!healthData()!.database.isConnected
									"
								>
									{{
										healthData()!.database.isConnected
											? "Connected"
											: "Disconnected"
									}}
								</span>
							</div>

							<div class="metric-row">
								<span class="metric-label">Response Time</span>
								<span
									class="metric-value"
									[class.value-warning]="
										healthData()!.database.responseTimeMs >
										100
									"
									[class.value-error]="
										healthData()!.database.responseTimeMs >
										500
									"
								>
									{{
										healthData()!.database.responseTimeMs
											| number: "1.2-2"
									}}ms
								</span>
							</div>

							<div class="metric-row">
								<span class="metric-label"
									>Active Connections</span
								>
								<span class="metric-value">
									{{
										healthData()!.database.activeConnections
									}}
								</span>
							</div>
						</div>
					</div>

					<!-- System Resources Card -->
					<div class="metric-card system-card">
						<div class="card-header">
							<mat-icon class="icon-primary">computer</mat-icon>
							<h3>System Resources</h3>
						</div>

						<div class="card-content">
							<div class="resource-metric">
								<div class="resource-header">
									<span class="metric-label">CPU Usage</span>
									<span
										class="metric-value"
										[class.value-warning]="
											healthData()!.system
												.cpuUsagePercent > 60
										"
										[class.value-error]="
											healthData()!.system
												.cpuUsagePercent > 80
										"
									>
										@if (
											healthData()!.system
												.cpuUsagePercent === 0
										)
										{
											Idle
										}
										@else
										{
											{{
												healthData()!.system
													.cpuUsagePercent
													| number: "1.1-1"
											}}%
										}
									</span>
								</div>
								<mat-progress-bar
									mode="determinate"
									[value]="
										healthData()!.system.cpuUsagePercent
									"
									[class]="
										getResourceStatusClass(
											healthData()!.system.cpuUsagePercent
										)
									"
								></mat-progress-bar>
							</div>

							<div class="resource-metric">
								<div class="resource-header">
									<span class="metric-label"
										>Memory Usage</span
									>
									<span
										class="metric-value"
										[class.value-warning]="
											memoryUsagePercent() > 60
										"
										[class.value-error]="
											memoryUsagePercent() > 80
										"
									>
										{{ healthData()!.system.memoryUsedMb }}
										MB /
										{{
											healthData()!.system.memoryTotalMb
												| number: "1.0-0"
										}}
										MB ({{ memoryUsagePercent() }}%)
									</span>
								</div>
								<mat-progress-bar
									mode="determinate"
									[value]="memoryUsagePercent()"
									[class]="
										getResourceStatusClass(
											memoryUsagePercent()
										)
									"
								></mat-progress-bar>
							</div>

							@if (healthData()!.system.diskUsagePercent > 0)
							{
								<div class="resource-metric">
									<div class="resource-header">
										<span class="metric-label"
											>Disk Usage</span
										>
										<span
											class="metric-value"
											[class.value-warning]="
												healthData()!.system
													.diskUsagePercent > 60
											"
											[class.value-error]="
												healthData()!.system
													.diskUsagePercent > 80
											"
										>
											{{
												healthData()!.system
													.diskUsagePercent
													| number: "1.1-1"
											}}%
										</span>
									</div>
									<mat-progress-bar
										mode="determinate"
										[value]="
											healthData()!.system
												.diskUsagePercent
										"
										[class]="
											getResourceStatusClass(
												healthData()!.system
													.diskUsagePercent
											)
										"
									></mat-progress-bar>
								</div>
							}
						</div>
					</div>

					<!-- Log Statistics Card -->
					@if (statisticsData())
					{
						<div class="metric-card stats-card">
							<div class="card-header">
								<mat-icon class="icon-primary"
									>analytics</mat-icon
								>
								<h3>Log Statistics</h3>
							</div>

							<div class="card-content">
								<div class="metric-row">
									<span class="metric-label">Total Logs</span>
									<span class="metric-value">
										{{
											statisticsData()!.totalLogs | number
										}}
									</span>
								</div>

								<div class="metric-row">
									<span class="metric-label">Errors</span>
									<span
										class="metric-value"
										[class.value-error]="
											statisticsData()!.errorCount > 0
										"
									>
										@if (statisticsData()!.errorCount > 0)
										{
											<mat-icon class="inline-icon"
												>error</mat-icon
											>
										}
										{{
											statisticsData()!.errorCount
												| number
										}}
									</span>
								</div>

								<div class="metric-row">
									<span class="metric-label">Warnings</span>
									<span
										class="metric-value"
										[class.value-warning]="
											statisticsData()!.warningCount > 0
										"
									>
										@if (
											statisticsData()!.warningCount > 0
										)
										{
											<mat-icon class="inline-icon"
												>warning</mat-icon
											>
										}
										{{
											statisticsData()!.warningCount
												| number
										}}
									</span>
								</div>

								@if (statisticsData()!.fatalCount > 0)
								{
									<div class="metric-row">
										<span class="metric-label">Fatal</span>
										<span class="metric-value value-error">
											<mat-icon class="inline-icon"
												>dangerous</mat-icon
											>
											{{
												statisticsData()!.fatalCount
													| number
											}}
										</span>
									</div>
								}
							</div>
						</div>

						<!-- Request Statistics Card -->
						<div class="metric-card request-card">
							<div class="card-header">
								<mat-icon class="icon-primary"
									>trending_up</mat-icon
								>
								<h3>Request Stats</h3>
							</div>

							<div class="card-content">
								<div class="metric-row">
									<span class="metric-label"
										>Total Requests</span
									>
									<span class="metric-value">
										{{
											statisticsData()!.totalRequests
												| number
										}}
									</span>
								</div>

								<div class="metric-row">
									<span class="metric-label"
										>Failed Requests</span
									>
									<span
										class="metric-value"
										[class.value-error]="
											statisticsData()!.failedRequests > 0
										"
									>
										@if (
											statisticsData()!.failedRequests > 0
										)
										{
											<mat-icon class="inline-icon"
												>error</mat-icon
											>
										}
										{{
											statisticsData()!.failedRequests
												| number
										}}
									</span>
								</div>

								<div class="metric-row">
									<span class="metric-label">Error Rate</span>
									<span
										class="metric-value"
										[class.value-warning]="
											errorRate() > 5 && errorRate() <= 10
										"
										[class.value-error]="errorRate() > 10"
									>
										{{ errorRate() }}%
									</span>
								</div>

								<div class="metric-row">
									<span class="metric-label"
										>Avg Response</span
									>
									<span
										class="metric-value"
										[class.value-warning]="
											statisticsData()!
												.averageResponseTimeMs > 1000 &&
											statisticsData()!
												.averageResponseTimeMs <= 5000
										"
										[class.value-error]="
											statisticsData()!
												.averageResponseTimeMs > 5000
										"
									>
										{{
											statisticsData()!
												.averageResponseTimeMs
												| number: "1.0-0"
										}}ms
									</span>
								</div>
							</div>
						</div>

						<!-- Top Error Sources Card -->
						<div class="metric-card wide-card error-sources-card">
							<div class="card-header">
								<mat-icon class="icon-error"
									>bug_report</mat-icon
								>
								<h3>Top Error Sources</h3>
							</div>

							<div class="card-content">
								@if (topErrorSources().length > 0)
								{
									@for (
										source of topErrorSources();
										track source.name
									)
									{
										<div class="list-item">
											<div class="list-item-content">
												<span class="list-item-name">{{
													source.name
												}}</span>
												<mat-chip
													class="count-chip"
													[highlighted]="true"
												>
													{{ source.count }}
												</mat-chip>
											</div>
											<div class="list-item-bar">
												<div
													class="bar-fill error-bar"
													[style.width.%]="
														(source.count /
															topErrorSources()[0]
																.count) *
														100
													"
												></div>
											</div>
										</div>
									}
								}
								@else
								{
									<p class="empty-message">
										No error sources recorded
									</p>
								}
							</div>
						</div>

						<!-- Top Request Paths Card -->
						<div class="metric-card wide-card request-paths-card">
							<div class="card-header">
								<mat-icon class="icon-primary">route</mat-icon>
								<h3>Top Request Paths</h3>
							</div>

							<div class="card-content">
								@if (topRequestPaths().length > 0)
								{
									@for (
										request of topRequestPaths();
										track request.path
									)
									{
										<div class="list-item">
											<div class="list-item-content">
												<span
													class="list-item-name path"
													>{{ request.path }}</span
												>
												<mat-chip
													class="count-chip"
													[highlighted]="true"
												>
													{{ request.count }}
												</mat-chip>
											</div>
											<div class="list-item-bar">
												<div
													class="bar-fill primary-bar"
													[style.width.%]="
														(request.count /
															topRequestPaths()[0]
																.count) *
														100
													"
												></div>
											</div>
										</div>
									}
								}
								@else
								{
									<p class="empty-message">
										No request paths recorded
									</p>
								}
							</div>
						</div>
					}
				</div>
			</mat-card-content>
		</mat-card>
	}
</div>
