<div
	class="health-status-panel"
	role="region"
	aria-label="System health status"
>
	@if (isLoading())
	{
		<div class="loading-container" role="status" aria-live="polite">
			<mat-spinner
				diameter="40"
				aria-label="Loading health status"
			></mat-spinner>
			<p>Loading health status...</p>
		</div>
	}
	@else if (error())
	{
		<div class="error-container" role="alert" aria-live="assertive">
			<mat-icon color="warn" aria-hidden="true">error</mat-icon>
			<p>{{ error() }}</p>
			<button
				mat-raised-button
				color="primary"
				(click)="onRefresh()"
				aria-label="Retry loading health status"
			>
				<mat-icon aria-hidden="true">refresh</mat-icon>
				Retry
			</button>
		</div>
	}
	@else if (healthData())
	{
		<mat-card>
			<mat-card-header>
				<mat-card-title>System Health Status</mat-card-title>
				<div class="overall-status">
					<mat-chip
						[class.status-healthy]="
							healthData()!.status === 'Healthy'
						"
						[class.status-degraded]="
							healthData()!.status === 'Degraded'
						"
						[class.status-unhealthy]="
							healthData()!.status === 'Unhealthy'
						"
						role="status"
						[attr.aria-label]="
							'Overall system status: ' + healthData()!.status
						"
					>
						@if (healthData()!.status === "Healthy")
						{
							<mat-icon aria-hidden="true">check_circle</mat-icon>
						}
						@else if (healthData()!.status === "Degraded")
						{
							<mat-icon aria-hidden="true">warning</mat-icon>
						}
						@else
						{
							<mat-icon aria-hidden="true">error</mat-icon>
						}
						{{ healthData()!.status }}
					</mat-chip>
				</div>
				<button
					mat-icon-button
					(click)="onRefresh()"
					aria-label="Refresh health status"
				>
					<mat-icon aria-hidden="true">refresh</mat-icon>
				</button>
			</mat-card-header>
			<mat-card-content>
				<div class="health-sections" role="list">
					<!-- Database Health -->
					<div class="health-section" role="listitem">
						<div class="section-header">
							<mat-icon aria-hidden="true">storage</mat-icon>
							<h3>Database</h3>
						</div>
						<div class="section-content">
							<div class="health-item">
								<mat-chip
									[class.status-healthy]="
										healthData()!.database.isConnected
									"
									[class.status-unhealthy]="
										!healthData()!.database.isConnected
									"
									role="status"
									[attr.aria-label]="
										'Database: ' +
										(healthData()!.database.isConnected
											? 'Connected'
											: 'Disconnected')
									"
								>
									{{
										healthData()!.database.isConnected
											? "Connected"
											: "Disconnected"
									}}
								</mat-chip>
							</div>
							<div class="health-metric">
								<span class="metric-label">Response Time:</span>
								<span class="metric-value"
									>{{
										healthData()!.database.responseTimeMs
									}}ms</span
								>
							</div>
							<div class="health-metric">
								<span class="metric-label"
									>Active Connections:</span
								>
								<span class="metric-value"
									>{{
										healthData()!.database.activeConnections
									}}
									active</span
								>
							</div>
						</div>
					</div>

					<!-- External APIs Health -->
					<div class="health-section">
						<div class="section-header">
							<mat-icon>api</mat-icon>
							<h3>External APIs</h3>
						</div>
						<div class="section-content">
							@for (apiName of getApiNames(); track apiName)
							{
								<div class="api-health-item">
									<div class="api-name">{{ apiName }}</div>
									<div class="api-details">
										<mat-chip
											[class.status-healthy]="
												healthData()!.externalApis.apis[
													apiName
												].isAvailable
											"
											[class.status-unhealthy]="
												!healthData()!.externalApis
													.apis[apiName].isAvailable
											"
										>
											{{
												healthData()!.externalApis.apis[
													apiName
												].isAvailable
													? "Available"
													: "Unavailable"
											}}
										</mat-chip>
										<span class="metric-value"
											>{{
												healthData()!.externalApis.apis[
													apiName
												].responseTimeMs
											}}ms</span
										>
									</div>
								</div>
							}
						</div>
					</div>

					<!-- Queue Health -->
					<div class="health-section">
						<div class="section-header">
							<mat-icon>queue</mat-icon>
							<h3>Queue</h3>
						</div>
						<div class="section-content">
							<div class="health-item">
								<mat-chip
									[class.status-healthy]="
										!healthData()!.errorQueue
											.circuitBreakerOpen
									"
									[class.status-unhealthy]="
										healthData()!.errorQueue
											.circuitBreakerOpen
									"
								>
									{{
										healthData()!.errorQueue
											.circuitBreakerOpen
											? "Circuit Open"
											: "Normal"
									}}
								</mat-chip>
							</div>
							<div class="health-metric">
								<span class="metric-label">Queued Items:</span>
								<span class="metric-value"
									>{{
										healthData()!.errorQueue.queuedItems
									}}
									queued</span
								>
							</div>
							<div class="health-metric">
								<span class="metric-label">Failed Items:</span>
								<span class="metric-value"
									>{{
										healthData()!.errorQueue.failedItems
									}}
									failed</span
								>
							</div>
						</div>
					</div>

					<!-- System Resources -->
					<div class="health-section">
						<div class="section-header">
							<mat-icon>computer</mat-icon>
							<h3>System Resources</h3>
						</div>
						<div class="section-content">
							<div class="health-metric">
								<span class="metric-label">CPU Usage:</span>
								<span
									class="metric-value"
									[class.metric-warning]="
										healthData()!.system.cpuUsagePercent >
										80
									"
								>
									{{ healthData()!.system.cpuUsagePercent }}%
								</span>
							</div>
							<div class="health-metric">
								<span class="metric-label">Memory Used:</span>
								<span
									class="metric-value"
									[class.metric-warning]="
										healthData()!.system.memoryUsedMb >
										healthData()!.system.memoryTotalMb * 0.8
									"
								>
									{{ healthData()!.system.memoryUsedMb }} MB /
									{{ healthData()!.system.memoryTotalMb }} MB
								</span>
							</div>
							<div class="health-metric">
								<span class="metric-label">Disk Usage:</span>
								<span
									class="metric-value"
									[class.metric-warning]="
										healthData()!.system.diskUsagePercent >
										80
									"
								>
									{{ healthData()!.system.diskUsagePercent }}%
								</span>
							</div>
						</div>
					</div>
				</div>
			</mat-card-content>
		</mat-card>
	}
</div>
