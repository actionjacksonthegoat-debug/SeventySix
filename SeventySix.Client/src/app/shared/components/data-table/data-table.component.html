<!-- Data Table Component -->
<div class="data-table-container">
	<!-- Toolbar Row 1: Search, Refresh, Column Select, Create -->
	<div class="table-toolbar">
		<!-- Search -->
		@if (searchable())
		{
			<mat-form-field appearance="outline" class="search-field">
				<mat-label>Search</mat-label>
				<input
					matInput
					[value]="searchText()"
					(input)="onSearchChange($any($event.target).value)"
					(keydown.enter)="onSearch()"
					placeholder="Search..."
					aria-label="Search table data"
				/>
				<mat-icon matIconPrefix aria-hidden="true">search</mat-icon>
				<button
					mat-icon-button
					matIconSuffix
					(click)="onSearch()"
					matTooltip="Search"
					aria-label="Execute search"
					type="button"
				>
					<mat-icon aria-hidden="true">search</mat-icon>
				</button>
			</mat-form-field>
		}

		<div class="spacer"></div>

		<!-- Refresh Button -->
		@if (showRefresh())
		{
			<button
				mat-icon-button
				(click)="onRefresh()"
				matTooltip="Refresh"
				aria-label="Refresh table data"
			>
				<mat-icon aria-hidden="true">refresh</mat-icon>
			</button>
		}

		<!-- Column Visibility -->
		<button
			mat-icon-button
			[matMenuTriggerFor]="columnMenu"
			matTooltip="Column visibility"
			aria-label="Toggle column visibility"
		>
			<mat-icon aria-hidden="true">view_column</mat-icon>
		</button>

		<!-- Create Button -->
		@if (showCreate())
		{
			<button
				mat-raised-button
				color="primary"
				(click)="onCreate()"
				aria-label="Create new item"
			>
				<mat-icon aria-hidden="true">add</mat-icon>
				Create
			</button>
		}
	</div>

	<!-- Toolbar Row 2: Filter Chips and Date Range -->
	@if (quickFilters().length > 0 || dateRangeEnabled())
	{
		<div class="filter-toolbar">
			<!-- Quick Filter Chips -->
			@if (quickFilters().length > 0)
			{
				<mat-chip-listbox
					class="filter-chips"
					aria-label="Quick filters"
				>
					@for (filter of quickFilters(); track filter.key)
					{
						<mat-chip-option
							[selected]="activeFilters().has(filter.key)"
							(click)="onFilterToggle(filter.key)"
						>
							@if (filter.icon)
							{
								<mat-icon aria-hidden="true">{{
									filter.icon
								}}</mat-icon>
							}
							{{ filter.label }}
						</mat-chip-option>
					}
				</mat-chip-listbox>
			}

			<div class="spacer"></div>

			<!-- Date Range Filter -->
			@if (dateRangeEnabled())
			{
				<div class="date-filter-chips">
					<!-- Date Range Dropdown Chip -->
					<button
						mat-stroked-button
						class="date-range-chip-button"
						[matMenuTriggerFor]="dateRangeMenu"
						aria-label="Select date range"
					>
						<mat-icon aria-hidden="true">{{
							dateRangeIcon()
						}}</mat-icon>
						{{ dateRangeLabel() }}
						<mat-icon class="dropdown-arrow" aria-hidden="true"
							>arrow_drop_down</mat-icon
						>
					</button>

					<!-- Date Range Menu -->
					<mat-menu #dateRangeMenu="matMenu">
						<button
							mat-menu-item
							(click)="onDateRangeChange('1h')"
							[class.active-range]="selectedDateRange() === '1h'"
						>
							<mat-icon aria-hidden="true">schedule</mat-icon>
							<span>1 Hour</span>
						</button>
						<button
							mat-menu-item
							(click)="onDateRangeChange('24h')"
							[class.active-range]="selectedDateRange() === '24h'"
						>
							<mat-icon aria-hidden="true">today</mat-icon>
							<span>24 Hours</span>
						</button>
						<button
							mat-menu-item
							(click)="onDateRangeChange('7d')"
							[class.active-range]="selectedDateRange() === '7d'"
						>
							<mat-icon aria-hidden="true">date_range</mat-icon>
							<span>7 Days</span>
						</button>
						<button
							mat-menu-item
							(click)="onDateRangeChange('30d')"
							[class.active-range]="selectedDateRange() === '30d'"
						>
							<mat-icon aria-hidden="true"
								>calendar_month</mat-icon
							>
							<span>30 Days</span>
						</button>
					</mat-menu>

					<!-- Result Count Chip -->
					@if (totalCount() > 0)
					{
						<span class="result-count-chip">
							{{ totalCount() }} result{{
								totalCount() !== 1 ? "s" : ""
							}}
						</span>
					}
				</div>
			}
		</div>
	}
	<!-- Column Visibility Menu -->
	<mat-menu #columnMenu="matMenu">
		@for (column of columns(); track column.key)
		{
			@if (column.type !== "actions")
			{
				<button
					mat-menu-item
					(click)="toggleColumn(column.key); $event.stopPropagation()"
				>
					<mat-icon aria-hidden="true">{{
						columnVisible(column.key)
							? "check_box"
							: "check_box_outline_blank"
					}}</mat-icon>
					{{ column.label }}
				</button>
			}
		}
	</mat-menu>

	<!-- Selection Action Panel (slides down when items selected) -->
	@if (hasSelection() && bulkActions().length > 0)
	{
		<div class="selection-panel" @slideDown>
			<div class="selection-info">
				<mat-icon aria-hidden="true">check_circle</mat-icon>
				<span>
					{{ selectedCount() }} item{{
						selectedCount() !== 1 ? "s" : ""
					}}
					selected
				</span>
			</div>
			<div class="selection-actions">
				@for (action of bulkActions(); track action.key)
				{
					<button
						mat-raised-button
						[color]="action.color || 'primary'"
						(click)="onBulkAction(action.key)"
					>
						<mat-icon aria-hidden="true">{{
							action.icon
						}}</mat-icon>
						{{ action.label }}
					</button>
				}
			</div>
		</div>
	}

	<!-- Table with Loading/Error Overlay (CLS Prevention) -->
	<div class="table-content-wrapper">
		<!-- Loading Overlay -->
		@if (isLoading())
		{
			<div
				class="loading-overlay"
				role="status"
				aria-label="Loading table data"
			>
				<mat-spinner diameter="50"></mat-spinner>
			</div>
		}

		<!-- Error Overlay -->
		@if (error() && !isLoading())
		{
			<div class="error-overlay">
				<mat-card class="error-card" role="alert">
					<mat-card-content>
						<mat-icon color="warn" aria-hidden="true"
							>error</mat-icon
						>
						{{ error() }}
					</mat-card-content>
				</mat-card>
			</div>
		}

		<!-- Table Content (always rendered for CLS prevention) -->
		<div class="table-content">
			<div class="table-wrapper">
				<cdk-virtual-scroll-viewport
					[appTableHeight]="400"
					[itemSize]="virtualScrollItemSize()"
					class="table-viewport"
				>
					<table
						mat-table
						[dataSource]="data()"
						matSort
						(matSortChange)="onSortChange($event)"
					>
						<!-- Select Column -->
						@if (selectable())
						{
							<ng-container matColumnDef="select">
								<th mat-header-cell *matHeaderCellDef>
									@if (showSelectAll())
									{
										<mat-checkbox
											[checked]="isAllSelected()"
											[indeterminate]="
												hasSelection() &&
												!isAllSelected()
											"
											(change)="toggleAllRows()"
											aria-label="Select all rows"
										>
										</mat-checkbox>
									}
								</th>
								<td mat-cell *matCellDef="let row">
									<mat-checkbox
										[checked]="selection.isSelected(row)"
										(change)="selection.toggle(row)"
										[aria-label]="'Select row ' + row.id"
									>
									</mat-checkbox>
								</td>
							</ng-container>
						}

						<!-- Data Columns -->
						@for (column of visibleColumns(); track column.key)
						{
							<ng-container [matColumnDef]="column.key">
								<th
									mat-header-cell
									*matHeaderCellDef
									[mat-sort-header]="
										column.sortable ? column.key : ''
									"
									[disabled]="!column.sortable"
								>
									{{ column.label }}
								</th>
								<td mat-cell *matCellDef="let row">
									@if (column.type === "badge")
									{
										<mat-chip>
											{{
												column.formatter
													? column.formatter(
															row[column.key],
															row
														)
													: row[column.key]
											}}
										</mat-chip>
									}
									@else if (column.type === "date")
									{
										{{
											column.formatter
												? column.formatter(
														row[column.key],
														row
													)
												: (row[column.key]
													| date: "short")
										}}
									}
									@else
									{
										{{
											column.formatter
												? column.formatter(
														row[column.key],
														row
													)
												: row[column.key]
										}}
									}
								</td>
							</ng-container>
						}

						<!-- Actions Column -->
						@if (rowActions().length > 0)
						{
							<ng-container matColumnDef="actions">
								<th mat-header-cell *matHeaderCellDef>
									Actions
								</th>
								<td mat-cell *matCellDef="let row">
									@if (rowActions().length === 1)
									{
										<!-- Single action: show icon directly -->
										<button
											mat-icon-button
											(click)="
												onRowAction(
													rowActions()[0].key,
													row
												);
												$event.stopPropagation()
											"
											[matTooltip]="rowActions()[0].label"
											[class.warn-action]="
												rowActions()[0].color === 'warn'
											"
											aria-label="Row action"
										>
											<mat-icon aria-hidden="true">{{
												rowActions()[0].icon
											}}</mat-icon>
										</button>
									}
									@else
									{
										<!-- Multiple actions: show menu -->
										<button
											mat-icon-button
											[matMenuTriggerFor]="actionMenu"
											(click)="$event.stopPropagation()"
											aria-label="Row actions"
										>
											<mat-icon aria-hidden="true"
												>more_vert</mat-icon
											>
										</button>
										<mat-menu #actionMenu="matMenu">
											@for (
												action of rowActions();
												track action.key
											)
											{
												@if (
													shouldShowAction(
														action,
														row
													)
												)
												{
													<button
														mat-menu-item
														(click)="
															onRowAction(
																action.key,
																row
															)
														"
														[class.warn-action]="
															action.color ===
															'warn'
														"
													>
														<mat-icon
															aria-hidden="true"
															>{{
																action.icon
															}}</mat-icon
														>
														{{ action.label }}
													</button>
												}
											}
										</mat-menu>
									}
								</td>
							</ng-container>
						}

						<tr
							mat-header-row
							*matHeaderRowDef="displayedColumns()"
						></tr>
						<tr
							mat-row
							*matRowDef="let row; columns: displayedColumns()"
							(click)="onRowClick(row)"
							class="data-row"
						></tr>
					</table>
				</cdk-virtual-scroll-viewport>
			</div>

			<!-- Paginator -->
			<mat-paginator
				[length]="totalCount()"
				[pageSize]="pageSize()"
				[pageIndex]="pageIndex()"
				[pageSizeOptions]="pageSizeOptions()"
				(page)="onPageChange($event)"
				aria-label="Table pagination"
			>
			</mat-paginator>
		</div>
	</div>
</div>
