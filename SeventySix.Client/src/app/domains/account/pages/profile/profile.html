<div class="profile-page">
	@if (isLoading()) {
	<mat-card>
		<mat-card-header>
			<ngx-skeleton-loader [theme]="skeletonTextShort" />
			<ngx-skeleton-loader [theme]="skeletonTextMedium" />
		</mat-card-header>
		<mat-card-content class="skeleton-form">
			<ngx-skeleton-loader [theme]="skeletonInput" />
			<ngx-skeleton-loader [theme]="skeletonInput" />
			<div class="skeleton-actions">
				<ngx-skeleton-loader [theme]="skeletonButton" />
			</div>
		</mat-card-content>
	</mat-card>
	} @else if (error()) {
	<mat-card class="error-card">
		<mat-card-content>{{ error() }}</mat-card-content>
	</mat-card>
	} @else if (profile(); as p) {
	<mat-card>
		<mat-card-header>
			<mat-card-title>{{ p.username }}</mat-card-title>
			@if (p.lastLoginAt) {
			<mat-card-subtitle>Last login {{ p.lastLoginAt | date }}</mat-card-subtitle>
			}
		</mat-card-header>

		<mat-card-content>
			<form
				[formGroup]="profileForm"
				(ngSubmit)="onSubmit()">
				<mat-form-field appearance="outline">
					<mat-label>Email</mat-label>
					<input
						matInput
						formControlName="email"
						type="email"
					/>
					<mat-error>
						{{ emailError() }}
					</mat-error>
				</mat-form-field>

				<mat-form-field appearance="outline">
					<mat-label>Full Name</mat-label>
					<input
						matInput
						formControlName="fullName"
					/>
				</mat-form-field>

				<div class="form-actions">
					<button
						mat-stroked-button
						color="primary"
						type="submit"
						[disabled]="
								profileForm.invalid ||
								profileForm.pristine ||
								isSaving()">
						@if (isSaving()) {
						<mat-spinner diameter="20" aria-label="Saving"></mat-spinner>
						} @else { Save Changes }
					</button>
					@if (hasAvailableRoles()) {
					<a
						mat-button
						routerLink="permissions">
						Request Permissions
					</a>
					}
				</div>
			</form>

			<!-- Linked Accounts -->
			<section class="linked-accounts"
				data-testid="linked-accounts"
				aria-labelledby="linked-accounts-heading">
				<h3 id="linked-accounts-heading">Linked Accounts</h3>
				<p class="linked-accounts-description">
					Connect external accounts for easier sign-in.
				</p>

				@for (provider of oauthProviders; track provider.id) {
					<div class="linked-provider-row">
						<mat-icon
							class="provider-icon"
							[svgIcon]="provider.icon"
							aria-hidden="true" />
						<span class="provider-name">{{ provider.displayName }}</span>

						@if (linkedProviderIds().has(provider.id)) {
							<button
								mat-stroked-button
								color="warn"
								(click)="onUnlinkProvider(provider.id)"
								[disabled]="!canUnlink() || unlinkMutation.isPending()"
								[attr.aria-label]="'Disconnect ' + provider.displayName">
								Disconnect
							</button>
						} @else {
							<button
								mat-stroked-button
								(click)="onLinkProvider(provider.id)"
								[disabled]="isOAuthInProgress()"
								[attr.aria-label]="'Connect ' + provider.displayName">
								Connect
							</button>
						}
					</div>
				}
			</section>
		</mat-card-content>
	</mat-card>
	}
</div>
