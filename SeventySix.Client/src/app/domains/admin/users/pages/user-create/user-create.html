<div class="user-create-page">
	<!-- Page Header -->
	<header class="page-header">
		<h1 class="mat-headline-5">Create New User</h1>
		<div class="page-actions">
			<button
				mat-stroked-button
				type="button"
				(click)="onCancel()"
				[disabled]="isSaving()">
				<mat-icon aria-hidden="true">
					close
				</mat-icon>
				Cancel
			</button>
		</div>
	</header>

	<!-- Error Alert -->
	@if (saveError()) {
	<mat-card
		appearance="outlined"
		class="alert-card error"
		data-testid="save-error-banner">
		<mat-card-content>
			<div class="alert-content">
				<mat-icon
					color="warn"
					aria-hidden="true">warning</mat-icon>
				<span class="mat-body-1">{{ saveError() }}</span>
			</div>
		</mat-card-content>
	</mat-card>
	}

	<!-- Stepper Content -->
	<div class="stepper-container">
		<mat-stepper
			#stepper
			[linear]="true"
			orientation="horizontal">
			<!-- Step 1: Basic Information -->
			<mat-step
				[stepControl]="basicInfoForm"
				label="Basic Information">
				<form [formGroup]="basicInfoForm">
					<mat-card appearance="outlined">
						<mat-card-header>
							<mat-card-title>User Details</mat-card-title>
							<mat-card-subtitle>
								Enter the basic user information
							</mat-card-subtitle>
						</mat-card-header>
						<mat-card-content>
							<!-- Username Field -->
							<mat-form-field
								appearance="outline"
								class="full-width">
								<mat-label>Username</mat-label>
								<input
									matInput
									formControlName="username"
									placeholder="Enter username"
									required
								/>
								<mat-icon
									matIconPrefix
									aria-hidden="true">
									person
								</mat-icon>
								<mat-error>
									{{ usernameError() }}
								</mat-error>
							</mat-form-field>

							<!-- Email Field -->
							<mat-form-field
								appearance="outline"
								class="full-width">
								<mat-label>Email</mat-label>
								<input
									matInput
									type="email"
									formControlName="email"
									placeholder="Enter email address"
									required
								/>
								<mat-icon
									matIconPrefix
									aria-hidden="true">email</mat-icon>
								<mat-error>
									{{ emailError() }}
								</mat-error>
							</mat-form-field>
						</mat-card-content>
					</mat-card>

					<div class="step-actions">
						<div class="flex-1"></div>
						<button
							mat-stroked-button
							color="primary"
							matStepperNext>
							Next
							<mat-icon aria-hidden="true">
								arrow_forward
							</mat-icon>
						</button>
					</div>
				</form>
			</mat-step>

			<!-- Step 2: Account Details -->
			<mat-step
				[stepControl]="accountDetailsForm"
				label="Account Details">
				<form [formGroup]="accountDetailsForm">
					<mat-card appearance="outlined">
						<mat-card-header>
							<mat-card-title>Additional Information</mat-card-title>
							<mat-card-subtitle>
								Configure account settings
							</mat-card-subtitle>
						</mat-card-header>
						<mat-card-content>
							<!-- Display Name Field (stored as fullName) -->
							<mat-form-field
								appearance="outline"
								class="full-width">
								<mat-label>Display Name</mat-label>
								<input
									matInput
									formControlName="fullName"
									placeholder="Enter display name"
									required
								/>
								<mat-icon
									matIconPrefix
									aria-hidden="true">
									badge
								</mat-icon>
								<mat-error>
									{{ fullNameError() }}
								</mat-error>
							</mat-form-field>
							<!-- Active Status -->
							<div class="checkbox-field">
								<mat-checkbox
									formControlName="isActive"
									color="primary">
									Active User
								</mat-checkbox>
								<p class="mat-body-2 field-hint">
									Active users can log in to the system
								</p>
							</div>
						</mat-card-content>
					</mat-card>

					<div class="step-actions">
						<button
							mat-stroked-button
							type="button"
							matStepperPrevious>
							<mat-icon aria-hidden="true">arrow_back</mat-icon>
							Back
						</button>
						<div class="flex-1"></div>
						<button
							mat-stroked-button
							color="primary"
							matStepperNext>
							Next
							<mat-icon aria-hidden="true">
								arrow_forward
							</mat-icon>
						</button>
					</div>
				</form>
			</mat-step>

			<!-- Step 3: Role Selection -->
			<mat-step label="Roles (Optional)">
				<mat-card appearance="outlined">
					<mat-card-header>
						<mat-card-title>Assign Roles</mat-card-title>
						<mat-card-subtitle>
							Select roles for this user (optional)
						</mat-card-subtitle>
					</mat-card-header>
					<mat-card-content>
					<p class="mat-body-1 role-hint">
						Select one or more roles to assign to the user.
						Roles can be added or removed later.
					</p>

					<mat-chip-listbox
						aria-label="Role selection"
						class="role-chips">
						@for (roleName of availableRoles; track roleName) {
								<mat-chip-option
								[selected]="selectedRolesSet().has(roleName)"
								(click)="toggleRole(roleName)">
								<mat-icon
									aria-hidden="true"
									matChipAvatar>
									{{ selectedRolesSet().has(roleName) ? "check_circle" : "radio_button_unchecked" }}
									</mat-icon>
									{{ roleName }}
								</mat-chip-option>
							}
						</mat-chip-listbox>

						@if (selectedRoles().length > 0) {
							<div class="selected-roles-summary">
								<p class="mat-body-2">Selected roles:</p>
								<mat-chip-set>
									@for (role of selectedRoles(); track role) {
										<mat-chip>
											{{ role }}
										</mat-chip>
									}
								</mat-chip-set>
							</div>
						}
					</mat-card-content>
				</mat-card>

				<div class="step-actions">
					<button
						mat-stroked-button
						type="button"
						matStepperPrevious>
						<mat-icon aria-hidden="true">arrow_back</mat-icon>
						Back
					</button>
					<div class="flex-1"></div>
					<button
							mat-stroked-button
						matStepperNext>
						Next
						<mat-icon aria-hidden="true">
							arrow_forward
						</mat-icon>
					</button>
				</div>
			</mat-step>

			<!-- Step 4: Review & Submit (lazy-rendered to ensure formData() reads
				current values; without matStepContent, Zoneless mode renders this
				content once during initial load when forms are still empty) -->
			<mat-step label="Review & Submit">
				<ng-template matStepContent>
				<mat-card appearance="outlined">
					<mat-card-header>
						<mat-card-title>Review User Information</mat-card-title>
						<mat-card-subtitle>
							Verify all details before creating the user
						</mat-card-subtitle>
					</mat-card-header>
					<mat-card-content>
						<div class="review-grid">
							<div class="review-item">
								<mat-icon
									class="review-icon"
									aria-hidden="true">
									person
								</mat-icon>
								<div class="review-details">
									<span class="mat-body-2 review-label">
										Username
									</span>
									<span class="mat-body-1">
										{{ formData().username }}
									</span>
								</div>
							</div>
							<div class="review-item">
								<mat-icon
									class="review-icon"
									aria-hidden="true">
									email
								</mat-icon>
								<div class="review-details">
									<span class="mat-body-2 review-label">
										Email
									</span>
									<span class="mat-body-1">
										{{ formData().email }}
									</span>
								</div>
							</div>
							<div class="review-item">
								<mat-icon
									class="review-icon"
									aria-hidden="true">badge</mat-icon>
								<div class="review-details">
									<span class="mat-body-2 review-label">
										Full Name
									</span>
									<span class="mat-body-1">
										{{ formData().fullName || "Not provided" }}
									</span>
								</div>
							</div>
							<div class="review-item">
								<mat-icon
									class="review-icon"
									aria-hidden="true">
									{{ formData().isActive ? "check_circle" : "cancel" }}
								</mat-icon>
								<div class="review-details">
									<span class="mat-body-2 review-label">
										Status
									</span>
									<span class="mat-body-1">
										{{ formData().isActive ? "Active" : "Inactive" }}
									</span>
								</div>
							</div>
							<div class="review-item">
								<mat-icon
									class="review-icon"
									aria-hidden="true">
									admin_panel_settings
								</mat-icon>
								<div class="review-details">
									<span class="mat-body-2 review-label">
										Roles
									</span>
									@if (selectedRoles().length > 0) {
										<mat-chip-set>
											@for (role of selectedRoles(); track role) {
												<mat-chip>
													{{ role }}
												</mat-chip>
											}
										</mat-chip-set>
									} @else {
										<span class="mat-body-1 text-muted">
											No roles selected
										</span>
									}
								</div>
							</div>
						</div>
					</mat-card-content>
				</mat-card>

				<div class="step-actions">
					<button
						mat-stroked-button
						type="button"
						matStepperPrevious>
						<mat-icon aria-hidden="true">arrow_back</mat-icon>
						Back
					</button>
					<div class="flex-1"></div>
					<button
						mat-stroked-button
						color="primary"
						type="button"
						data-testid="create-user-button"
						(click)="onSubmit()"
						[disabled]="isSaving()">
						@if (isSaving()) {
						<mat-spinner diameter="20" aria-label="Creating user"></mat-spinner>
						} @else {
						<ng-container>
							<mat-icon aria-hidden="true">check</mat-icon>
							Create User
						</ng-container>
						}
					</button>
				</div>
				</ng-template>
			</mat-step>
		</mat-stepper>
	</div>
</div>
