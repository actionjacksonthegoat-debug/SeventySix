// <copyright file="TimeProviderUsageTests.cs" company="SeventySix">
// Copyright (c) SeventySix. All rights reserved.
// </copyright>

using System;
using System.Collections.Generic;
using System.IO;
using System.Text.RegularExpressions;
using Shouldly;
using Xunit;

namespace SeventySix.ArchitectureTests;

/// <summary>
/// Architectural tests to enforce TimeProvider usage.
/// Direct DateTime.UtcNow usage prevents testability and must be replaced.
/// </summary>
/// <remarks>
/// Per CLAUDE.md and copilot-instructions.md:
/// - NEVER use DateTime.UtcNow directly in any code (production or tests)
/// - ALWAYS inject TimeProvider for testable time abstraction
/// - Tests should use TestTimeProvider or mock TimeProvider
/// </remarks>
public class TimeProviderUsageTests : SourceCodeArchitectureTest
{
	/// <summary>
	/// Files that are explicitly allowed to use DateTime.UtcNow.
	/// These should be empty - no exceptions allowed per YAGNI.
	/// </summary>
	private static readonly HashSet<string> AllowedExceptions =
		new(StringComparer.OrdinalIgnoreCase)
		{
			// This test file itself contains DateTime.UtcNow in regex patterns and documentation
			"TimeProviderUsageTests.cs",
			// Analyzer tests contain DateTime.UtcNow in test code strings being analyzed (not actual usage)
			"AssignmentContinuationIndentCodeFixTests.cs",
			// EF Migrations / snapshot and seed/config files are allowed to contain literal DateTime for seeding purposes
			"SecurityRoleConfiguration.cs",
			// Allow analyzer sources and analyzer tests that contain intentional DateTime strings for testing purposes
			"DateTimeUsageAnalyzer.cs",
			"DateTimeUsageAnalyzerTests.cs",
		};

	// If file is an EF Migrations snapshot (sometimes autogenerated in Migrations folder), exclude it as well
	private static bool IsModelSnapshot(string fileName) =>
		fileName.Contains(
			"ModelSnapshot",
			System.StringComparison.OrdinalIgnoreCase);

	[Fact]
	public void All_Code_Should_Use_TimeProvider_Not_DateTime_UtcNow()
	{
		// Arrange - check ALL code including tests using GetAllSourceFiles
		IEnumerable<string> sourceFiles = GetAllSourceFiles();

		List<string> violations = [];

		// Act
		foreach (string filePath in sourceFiles)
		{
			string fileName =
				Path.GetFileName(filePath);

			if (AllowedExceptions.Contains(fileName))
			{
				continue;
			}

			string fileContent =
				ReadFileContent(filePath);
			string relativePath =
				GetRelativePath(filePath);

			// Skip generated files and EF migrations to avoid false positives
			if (
				relativePath.Contains(
					$"{Path.DirectorySeparatorChar}Migrations{Path.DirectorySeparatorChar}")
				|| relativePath.Contains(
					$"{Path.DirectorySeparatorChar}obj{Path.DirectorySeparatorChar}")
				|| relativePath.Contains(
					$"{Path.DirectorySeparatorChar}bin{Path.DirectorySeparatorChar}")
				|| relativePath.Contains(".vs")
				|| fileName.EndsWith(".Designer.cs")
				|| fileName.EndsWith(".g.cs")
				|| fileName.EndsWith(".g.i.cs")
				|| IsModelSnapshot(fileName))
			{
				continue;
			}

			// Find DateTime usages (UtcNow, Now, new DateTime(...), or System.DateTime)
			MatchCollection matches =
				Regex.Matches(
					fileContent,
					@"\bDateTime\.(UtcNow|Now)\b|\bSystem\.DateTime\b",
					RegexOptions.Multiline);

			if (matches.Count > 0)
			{
				violations.Add(
					$"{relativePath}: {matches.Count} DateTime usage(s) (UtcNow/Now/new DateTime/System.DateTime)"
						+ " - inject TimeProvider or use approved TestTimeProvider in tests");
			}
		}

		// Assert
		violations.ShouldBeEmpty();
	}
}