---
description: Full blueprint for adding a new bounded context domain
---

# New Domain Blueprint

> Manual reference only (no `applyTo`) — used when scaffolding a new bounded context.

## Domain Size Guidance

| Size      | When to Use                                             | Project Structure                                                                    |
| --------- | ------------------------------------------------------- | ------------------------------------------------------------------------------------ |
| **Small** | Simple bounded context (few entities, minimal logic)    | Folder inside `SeventySix.Domains/` (e.g., `ApiTracking/`, `Logging/`)               |
| **Large** | Complex bounded context (many entities, services, jobs) | Separate project `SeventySix.Domains.{Name}/` (e.g., `SeventySix.Domains.Identity/`) |

**Rule**: If a domain needs >5 entities OR its own background jobs OR complex service layer → separate project.

---

## Server Checklist (Large Domain — Separate Project)

```
SeventySix.Domains.{NewDomain}/
├── SeventySix.Domains.{NewDomain}.csproj  (refs SeventySix.Shared ONLY)
├── Commands/
│   └── {Action}{Entity}/
│       ├── {Action}{Entity}Command.cs           # Record
│       ├── {Action}{Entity}CommandHandler.cs     # Static class + static HandleAsync
│       └── {Action}{Entity}RequestValidator.cs   # FluentValidation (optional)
├── Queries/
│   └── Get{Entity}ById/
│       ├── Get{Entity}ByIdQuery.cs
│       └── Get{Entity}ByIdQueryHandler.cs
├── Entities/
│   └── {Entity}.cs                              # Implements IEntity / IAuditableEntity
├── Infrastructure/
│   ├── {NewDomain}DbContext.cs                  # One per bounded context
│   └── Configurations/
│       └── {Entity}Configuration.cs             # Fluent API, HasDefaultSchema
├── POCOs/
│   ├── DTOs/       → {Entity}Dto.cs             # Positional record
│   ├── Requests/   → {Action}{Entity}Request.cs
│   ├── Responses/  → {Entity}Response.cs        # If API contract output
│   └── Results/    → {Entity}Result.cs          # If internal operation outcome
├── Registration/
│   ├── {NewDomain}Registration.cs               # Add{NewDomain}Domain() extension
│   └── {NewDomain}JobSchedulerContributor.cs    # If background jobs needed
├── Services/       → {Entity}Service.cs         # Primary constructor, sealed
├── Repositories/   → {Entity}Repository.cs
├── Settings/
│   ├── {NewDomain}Settings.cs                   # Record with get/init
│   └── {NewDomain}SettingsValidator.cs          # FluentValidation
├── Constants/      → {NewDomain}Constants.cs
├── Exceptions/     → {Entity}NotFoundException.cs  # Extends EntityNotFoundException
├── Interfaces/     → I{Entity}Service.cs
├── Migrations/     → (generated by EF Core — NEVER in Infrastructure/Migrations/)
└── Extensions/     → {Entity}MappingExtensions.cs  # ToDto() extension methods
```

## Server Wiring Steps

1. **Create .csproj** referencing `SeventySix.Shared` only
2. **Add project reference** in `SeventySix.Api.csproj`
3. **Add test project** `Tests/SeventySix.Domains.{NewDomain}.Tests/`
4. **Create DbContext** with schema name matching domain
5. **Create Registration** extension method: `Add{NewDomain}Domain()`
6. **Call Registration** from `SeventySix.Api/Registration/ApplicationServicesRegistration.cs`
7. **Add connection string** mapping in `appsettings.*.json`
8. **Create initial migration**: `dotnet ef migrations add InitialCreate -c {NewDomain}DbContext -o {NewDomain}/Migrations`
9. **Add controller(s)** to `SeventySix.Api/Controllers/V1/`
10. **Add health check** via `AddWolverineHealthCheck<Check{NewDomain}HealthQuery>()`

## Registration Template

```csharp
public static class {NewDomain}Registration
{
	public static IServiceCollection Add{NewDomain}Domain(
		this IServiceCollection services,
		string connectionString,
		IConfiguration configuration)
	{
		services.AddDomainDbContext<{NewDomain}DbContext>(
			connectionString,
			SchemaConstants.{NewDomain});

		services.AddScoped<I{Entity}Repository, {Entity}Repository>();
		services.AddTransactionManagerFor<{NewDomain}DbContext>();
		services.AddWolverineHealthCheck<Check{NewDomain}HealthQuery>(
			SchemaConstants.{NewDomain});
		services.AddDomainValidatorsFromAssemblyContaining<{NewDomain}DbContext>();

		return services;
	}
}
```

---

## Client Checklist

```
SeventySix.Client/src/app/domains/{new-domain}/
├── models/
│   ├── {entity}.model.ts              # Type alias from OpenAPI generated types
│   ├── {entity}-query-request.model.ts
│   └── index.ts                       # Barrel export
├── services/
│   └── {entity}.service.ts            # @Injectable() — NO providedIn
├── pages/
│   └── {entity}-management/
│       ├── {entity}-management.ts     # Page component (smart container)
│       ├── {entity}-management.html
│       └── {entity}-management.scss
├── components/
│   └── {entity}-list/
│       ├── {entity}-list.ts           # Feature component
│       ├── {entity}-list.html
│       └── {entity}-list.scss
├── constants/
│   └── {new-domain}.constants.ts
├── testing/
│   └── {new-domain}-mock-factories.ts
└── {new-domain}.routes.ts             # Exported as {NEW_DOMAIN}_ROUTES
```

## Client Wiring Steps

1. **Add path alias** in `tsconfig.json`: `"@{new-domain}/*": ["src/app/domains/{new-domain}/*"]`
2. **Create route file** exporting `{NEW_DOMAIN}_ROUTES: Routes`
3. **Add lazy route** in `app.routes.ts` with `loadChildren` + guards
4. **Register services** at route level via `providers: [...]`
5. **Regenerate OpenAPI types** if new API endpoints: `npm run generate:openapi`
6. **Add navigation** if needed (sidebar, breadcrumbs)

## Route Template

```typescript
import { Routes } from "@angular/router";
import { passwordChangeGuard, roleGuard } from "@shared/guards";
import { {Entity}Service } from "@{new-domain}/services";

export const {NEW_DOMAIN}_ROUTES: Routes =
	[
		{
			path: "",
			providers: [{Entity}Service],
			canMatch: [passwordChangeGuard(), roleGuard("Admin")],
			children: [
				{
					path: "",
					loadComponent: () =>
						import("./pages/{entity}-management/{entity}-management")
							.then(
								(module) => module.{Entity}ManagementComponent),
				},
			],
		},
	];
```

---

## Test Checklist

> **80/20 Rule**: Focus test coverage on the **20% of code that carries 80% of risk** — command handlers with business logic, validation rules, and authorization checks.

```
Tests/SeventySix.Domains.{NewDomain}.Tests/
├── SeventySix.Domains.{NewDomain}.Tests.csproj
├── Commands/
│   └── {Action}{Entity}CommandHandlerTests.cs   # Highest priority — business logic
├── Queries/
│   └── Get{Entity}ByIdQueryHandlerTests.cs      # Only if query has non-trivial logic
├── Services/
│   └── {Entity}ServiceTests.cs                  # Only for services with branching logic
├── Validators/
│   └── {Action}{Entity}RequestValidatorTests.cs  # Validation rules are high-value tests
└── Builders/
    └── {Entity}Builder.cs                        # Fluent builder for test data
```

> See `testing-server.instructions.md` → "80/20 Test Priority" for the full server-side priority list.

---

## Validation Gate (Cannot Skip)

- [ ] `dotnet build` — zero warnings
- [ ] `ng build` — zero warnings
- [ ] `eslint` — zero warnings
- [ ] `dotnet test` — all pass
- [ ] `npm test` — all pass
- [ ] `npm run test:e2e` — all pass
- [ ] No IDE yellow squiggles in modified files

