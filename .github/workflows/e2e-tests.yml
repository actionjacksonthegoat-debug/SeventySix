name: E2E Tests

on:
    push:
        branches: [master, develop]
    pull_request:
        branches: [master, develop]
    schedule:
        # Run E2E tests daily at 2 AM UTC
        - cron: "0 2 * * *"

jobs:
    e2e-tests:
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"
                  cache-dependency-path: SeventySix.Client/package-lock.json

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"

            - name: Install client dependencies
              working-directory: SeventySix.Client
              run: npm ci

            - name: Install Playwright browsers
              working-directory: SeventySix.Client
              run: npx playwright install --with-deps chromium

            - name: Build client
              working-directory: SeventySix.Client
              run: npm run build

            - name: Restore server dependencies
              working-directory: SeventySix.Server
              run: dotnet restore SeventySix.Server.slnx

            - name: Build server
              working-directory: SeventySix.Server
              run: dotnet build SeventySix.Server.slnx --configuration Release --no-restore

            - name: Start API server
              working-directory: SeventySix.Server/SeventySix.Api
              run: |
                  dotnet run --configuration Release --no-build &
                  echo $! > api.pid
                  sleep 10

            - name: Start client dev server
              working-directory: SeventySix.Client
              run: |
                  npm start &
                  echo $! > client.pid
                  sleep 10

            - name: Wait for servers to be ready
              run: |
                  timeout 60 bash -c 'until curl -k https://localhost:7074/scalar/v1 2>/dev/null; do sleep 2; done'
                  timeout 60 bash -c 'until curl http://localhost:4200 2>/dev/null; do sleep 2; done'

            - name: Run E2E tests
              working-directory: SeventySix.Client
              run: npm run test:e2e

            - name: Stop servers
              if: always()
              run: |
                  if [ -f SeventySix.Server/SeventySix.Api/api.pid ]; then
                    kill $(cat SeventySix.Server/SeventySix.Api/api.pid) || true
                  fi
                  if [ -f SeventySix.Client/client.pid ]; then
                    kill $(cat SeventySix.Client/client.pid) || true
                  fi

            - name: Upload Playwright report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: playwright-report
                  path: SeventySix.Client/playwright-report
                  retention-days: 7

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: e2e-test-results
                  path: SeventySix.Client/test-results
                  retention-days: 7
